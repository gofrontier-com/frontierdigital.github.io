<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=author content="Frontier Digital Ltd"><meta name=description content><meta name=keywords content="devops,finops,cloudops,code,git,gitops,github,platform engineering,cloud,infrastructure,iaas,paas,saas,zure,aws,gcp,automated,automation,secure,security,observable,observability,internal developer platform,idp,agile,shift left,continuous integration,ci,continuous deployment,cd,sonatype,nexus,firewall,iq,repository,kubernetes,openshift,terraform,iac,ansible"><meta name=viewport content="width=device-width,initial-scale=1"><title>Azure DevOps Pipelines with multiple schedules</title><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=icon href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=152x152 href=/images/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-touch-icon-76x76.png><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=icon href=/images/apple-touch-icon.png type=image/x-icon><link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel=stylesheet><link href=/css/bootstrap.min.css rel=stylesheet><link href=/css/flaticon.css rel=stylesheet><link href=/css/menu.css rel=stylesheet><link id=effect href=/css/dropdown-effects/fade-down.css media=all rel=stylesheet><link href=/css/magnific-popup.css rel=stylesheet><link href=/css/owl.carousel.min.css rel=stylesheet><link href=/css/owl.theme.default.min.css rel=stylesheet><link href=/css/animate.css rel=stylesheet><link href=/css/style.css rel=stylesheet><link href=/css/frontier.css rel=stylesheet><link href=/css/responsive.css rel=stylesheet><script id=Cookiebot src=https://consent.cookiebot.com/uc.js data-cbid=cf364c43-071d-4332-84f3-f504a842bd1c data-blockingmode=auto type=text/javascript></script>
<script type=text/javascript>(function(e,t){var o,i,a,r,c,l,d,u,n=e.amplitude||{_q:[],_iq:{}},s=t.createElement("script");s.type="text/javascript",s.integrity="sha384-+EO59vL/X7v6VE2s6/F4HxfHlK0nDUVWKVg8K9oUlvffAeeaShVBmbORTC2D3UF+",s.crossOrigin="anonymous",s.async=!0,s.src="https://cdn.amplitude.com/libs/amplitude-8.17.0-min.gz.js",s.onload=function(){e.amplitude.runQueuedFunctions||console.log("[Amplitude] Error: could not load SDK")},a=t.getElementsByTagName("script")[0],a.parentNode.insertBefore(s,a);function h(e,t){e.prototype[t]=function(){return this._q.push([t].concat(Array.prototype.slice.call(arguments,0))),this}}r=function(){return this._q=[],this},c=["add","append","clearAll","prepend","set","setOnce","unset","preInsert","postInsert","remove"];for(o=0;o<c.length;o++)h(r,c[o]);n.Identify=r,l=function(){return this._q=[],this},d=["setProductId","setQuantity","setPrice","setRevenueType","setEventProperties"];for(i=0;i<d.length;i++)h(l,d[i]);n.Revenue=l,u=["init","logEvent","logRevenue","setUserId","setUserProperties","setOptOut","setVersionName","setDomain","setDeviceId","enableTracking","setGlobalUserProperties","identify","clearUserProperties","setGroup","logRevenueV2","regenerateDeviceId","groupIdentify","onInit","logEventWithTimestamp","logEventWithGroups","setSessionId","resetSessionId"];function m(e){function n(t){e[t]=function(){e._q.push([t].concat(Array.prototype.slice.call(arguments,0)))}}for(var t=0;t<u.length;t++)n(u[t])}m(n),n.getInstance=function(e){return e=(!e||e.length===0?"$default_instance":e).toLowerCase(),Object.prototype.hasOwnProperty.call(n._iq,e)||(n._iq[e]={_q:[]},m(n._iq[e])),n._iq[e]},e.amplitude=n})(window,document),amplitude.getInstance().init("ceb6feb4b534124b3c7524c41f612791"),amplitude.getInstance().logEvent("Azure DevOps Pipelines with multiple schedules")</script></head><body><div id=loading class=orange-red-loading><div id=loading-center><div id=loading-center-absolute><div class=object id=object_one></div><div class=object id=object_two></div><div class=object id=object_three></div><div class=object id=object_four></div></div></div></div><div id=page class=page><header id=header class="header white-menu navbar-dark"><div class=header-wrapper><div class="wsmobileheader clearfix"><span class=smllogo><img src=/images/logo-01.png alt=mobile-logo></span>
<a id=wsnavtoggle class=wsanimated-arrow><span></span></a></div><div class="wsmainfull menu clearfix"><div class="wsmainwp clearfix"><div class=desktoplogo><a href=/ class=logo-black><img src=/images/white-logo-f.png alt=header-logo></a></div><div class=desktoplogo><a href=/ class=logo-white><img src=/images/footer-logo.jpg alt=header-logo></a></div><nav class="wsmenu clearfix"><ul class="wsmenu-list nav-orange-red-hover"><li class=nl-simple aria-haspopup=true><a href=/>Home</a></li><li class=nl-simple aria-haspopup=true><a href=/services/>Services</a></li><li class=nl-simple aria-haspopup=true><a href=/blog/>Blog</a></li><li class=nl-simple aria-haspopup=true><a href=/about/>About</a></li><li class=nl-simple aria-haspopup=true><a href="javascript:window.location.href=atob('bWFpbHRvOmhlbGxvQGZyb250aWVyLWRpZ2l0YWwuY28udWsK')" class="btn btn-tra-white orange-red-hover last-link">Contact</a></li></ul></nav></div></div></div></header><section id=single-post class="wide-100 inner-page-hero single-post-section division"><div class=container><div class=row><div class="col-lg-10 offset-lg-1"><div class=single-post-wrapper><div class=single-post-title><p class="p-sm post-tag txt-500 txt-upcase">post</p><h2 class=h2-md>Azure DevOps Pipelines with multiple schedules</h2><div class="post-data clearfix"><div class=post-author-avatar><img src=/images/neil.jpg alt=author-avatar></div><div class=post-author><h6 class=h6-xl>Neil Cowlin</h6><p class=p-md>Posted on Dec 4, 2022</p></div></div></div><div class="single-post-txt blog"><h1 id=azure-devops-pipelines-with-multiple-schedules>Azure DevOps Pipelines with multiple schedules</h1><h2 id=context>Context</h2><p>A client is aware that significant cost savings could be realised by a scheduled manipulation of some of their deployed resources and services. Their working week leads to predictable hot and cold periods in the utilisation of their build services and pre-production environments in which scaling up and down could take place.</p><p>The resources in question don&rsquo;t have any other suitable means to scale based on demand.</p><p>The client wants an Azure DevOps native solution, and everything is deployed by ADO pipelines.</p><h2 id=the-goal>The goal</h2><p>I would like to provide a single pipeline, which executes on a defined schedule, and applies some settings appropriate for that time. Sort of like an old programmable thermostat.</p><p>Simplistically, it&rsquo;s likely to be &ldquo;run a scale up&rdquo; or &ldquo;run a scale down&rdquo;.</p><p>ADO provides scheduled triggers, defined using a cron syntax. You can set a pipeline to run whenever you want. You can set multiple cron schedules for a single job.</p><p>I&rsquo;m picturing a pipeline something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># Two trigger definitions</span>
</span></span><span style=display:flex><span><span style=color:#f92672>schedules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>cron</span>: <span style=color:#e6db74>&#34;0 18 * * Mon-Fri&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>Every weekday at 1800</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>include</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>always</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>cron</span>: <span style=color:#e6db74>&#34;0 8 * * Mon-Fri&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>displayName</span>: <span style=color:#ae81ff>Every weekday at 0800</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>include</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>always</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>stages</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>Run_task</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>job</span>: <span style=color:#ae81ff>Task</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>pool</span>: <span style=color:#ae81ff>hubAgents</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>bash</span>: <span style=color:#75715e># do different stuff depending on which cron schedule triggered us</span>
</span></span></code></pre></div><h2 id=ado-limitations>ADO Limitations</h2><p>However, there’s a painful limitation: you cannot - within the YAML schema - set parameters or variables per trigger. Moreover, a running pipeline doesn’t &ldquo;know&rdquo; which particular cron schedule triggered it.</p><p>ADO exposes many <a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&tabs=yaml#agent-variables-devops-services">built in variables</a>, but it strangely seems that inspecting the trigger is one of them.</p><p>You could create multiple pipelines - one for each schedule - with some hardcoded set of arguments to pass to your pipeline payload template, but that creates duplication, and will get unmanageable quickly. I am also working in a <a href=https://frontierdigital.net/>Frontier Digital</a> ADO framework where GitOps rules all, and there’s automation both upstream and downstream creating and consuming the config - even <em>this</em> pipeline will be programmatically created!</p><h2 id=rest-api-to-the-rescue>REST API to the rescue</h2><p>There is however the trusty ADO REST API. It has all the trigger information - what we need is for our pipeline to query the API for information about itself as it&rsquo;s running.</p><p>We can see in <a href="https://learn.microsoft.com/en-us/rest/api/azure/devops/build/builds/get?view=azure-devops-rest-6.1#build">the docs</a> that the <code>builds/build</code> endpoint returns an object containing what we need:</p><p>Here&rsquo;s an example of the API response from the endpoints that we&rsquo;re interested in</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;triggerInfo&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;scheduleName&#34;</span>: <span style=color:#e6db74>&#34;Every weekday at 1800&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Where <code>scheduleName</code> contains the <code>displayName</code> for the triggering schedule.</p><p>This can be done with a relatively simple <code>bash</code> task using <code>curl</code>, piping the returned JSON into <code>jq</code> to allow us to pull out what we’re after and set a variable.</p><p>This task is completely portable with no parameters needed as all settings can be pulled from built in variables!</p><h3 id=the-task>The task</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>bash</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      set -euo pipefail
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      schedule_name=$( \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        curl \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          -H &#34;Content-Type: application/json&#34; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          -s \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          -u &#34;:$(System.AccessToken)&#34; `# authenticate with Access Token` \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &#34;$(System.CollectionUri)/$(System.TeamProject)/_apis/build/builds/$(Build.BuildId)?api-version=7.0&#34; |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        jq --raw-output &#39;.triggerInfo.scheduleName&#39; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      )
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      echo &#34;##vso[task.setvariable variable=scheduleName]$schedule_name&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      echo &#34;##vso[task.setvariable variable=scheduleName;isOutput=true]$schedule_name&#34;</span>      
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>getScheduleName</span>
</span></span></code></pre></div><h4 id=building-up-the-api-endpoint>Building up the API endpoint</h4><ul><li><code>System.CollectionUri</code>: <code>https://dev.azure.com/my-org/</code></li><li><code>System.TeamProject</code>: <code>my-project</code></li><li><code>Build.BuildId</code>: The Id for <em>this</em> running pipeline</li></ul><h4 id=jq-options>jq options</h4><ul><li><code>--raw-output</code>: removes quotes around the returned value</li></ul><p>The task sets a variable <code>$schedule_name</code> (and an output variable too, for multi stage goodness), which can be passed on to whatever the main payload of the pipeline is.</p><p>In my situation, I use it to filter a configuration file. The payload itself doesn&rsquo;t need to know if it&rsquo;s scaling up or down, it&rsquo;s just applying whatever the filtered configuration is!</p><p>Unfortunately this variable is obviously only available at run time, so can’t be used as a template variable for ADO native template conditions etc. You have to make some switching within your main payload.</p><h3 id=non-scheduled-pipeline-runs>Non-scheduled pipeline runs</h3><p>Manual runs of the pipeline won&rsquo;t have a <code>scheduleName</code> set. The returned object looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>&#34;triggerInfo&#34;</span>: {},
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>In this instance, our task returns a string with the literal value <code>null</code>. We can handle this special case in our code.</p><h2 id=summary>Summary</h2><p>It would be great if ADO just exposed this information for us, but at least this way we can work around it and have one scheduled pipeline that handles all the cases.</p></div><div class="row post-share-links d-flex align-items-center"></div></div></div></div></div></section><section id=blog-1 class="bg-whitesmoke-gradient wide-60 blog-section division"><div class=container><div class="row justify-content-center"><div class="col-lg-10 col-xl-8"><div class="section-title title-01 mb-70"><h5 class=h5-md>Keep reading...</h2></div></div></div><div class="row row-cols-1 row-cols-md-2 row-cols-lg-3"><div class=col><div id=bp-1-1 class="blog-1-post mb-40 wow fadeInUp"><div class=blog-post-img><div class=hover-overlay><img class=img-fluid src=/images/containers.jpg alt=blog-post-image><div class=item-overlay></div></div></div><div class=blog-post-txt><p class="p-md post-tag">post &ensp;|&ensp; June 12, 2021</p><h5 class=h5-md><a href=https://frontierdigital.net/blog/autoscaling-kubernetes-workloads/>Autoscaling Kuberenetes workloads with custom schedules</a></h5><p class=p-lg>Autoscaling Kuberenetes workloads with custom schedules Context Would you like to know how we cut annual cloud costs by over 45% for one of our major financial services clients? Read on!
Following on from a previous blog post where we discovered how to make use of custom schedules in ADO pipelines, we decided to use the same mechanism as part of our FinOps practices for one of our major clients.</p></div></div></div><div class=col><div id=bp-1-1 class="blog-1-post mb-40 wow fadeInUp"><div class=blog-post-img><div class=hover-overlay><img class=img-fluid src=/images/simplicity.jpg alt=blog-post-image><div class=item-overlay></div></div></div><div class=blog-post-txt><p class="p-md post-tag">post &ensp;|&ensp; June 12, 2021</p><h5 class=h5-md><a href=https://frontierdigital.net/blog/misconception-simplicity/>The misconception of simplicity</a></h5><p class=p-lg>Cloud platforms are increasing in popularity, is the current perception correct?</p></div></div></div><div class=col><div id=bp-1-1 class="blog-1-post mb-40 wow fadeInUp"><div class=blog-post-img><div class=hover-overlay><img class=img-fluid src=/images/pipelines.jpg alt=blog-post-image><div class=item-overlay></div></div></div><div class=blog-post-txt><p class="p-md post-tag">post &ensp;|&ensp; June 12, 2021</p><h5 class=h5-md><a href=https://frontierdigital.net/blog/azure-devops-pipelines-with-multiple-schedules/>Azure DevOps Pipelines with multiple schedules</a></h5><p class=p-lg>Azure DevOps Pipelines with multiple schedules Context A client is aware that significant cost savings could be realised by a scheduled manipulation of some of their deployed resources and services. Their working week leads to predictable hot and cold periods in the utilisation of their build services and pre-production environments in which scaling up and down could take place.
The resources in question don&rsquo;t have any other suitable means to scale based on demand.</p></div></div></div><div class=col><div id=bp-1-1 class="blog-1-post mb-40 wow fadeInUp"><div class=blog-post-img><div class=hover-overlay><img class=img-fluid src=/images/whyfd.jpg alt=blog-post-image><div class=item-overlay></div></div></div><div class=blog-post-txt><p class="p-md post-tag">post &ensp;|&ensp; June 12, 2021</p><h5 class=h5-md><a href=https://frontierdigital.net/blog/why-frontier-digital/>Why Frontier Digital?</a></h5><p class=p-lg>It’s time for your business to move to the Cloud, but how do you ensure you get there safely, securely and without it running away with the pennies?</p></div></div></div></div></div></section><footer id=footer-1 class="footer division"><div class=container><div class=row><div class=col-lg-4><div class="footer-info mb-40"><img class="footer-logo mb-25" src=/images/footer-logo.jpg alt=footer-logo></div></div><div class="col-sm-12 col-md-6 col-lg-2 col-xl-4"><div class="footer-links mb-40"><h6 class=h6-xl>Company</h6><ul class="foo-links text-secondary clearfix"><li><p class=p-md><a href=/about/>About Us</a></p></li><li><p class=p-md><a href=/services/>Services</a></p></li><li><p class=p-md><a href=/blog/>Blog</a></p></li><li><p class=p-md><a href="javascript:window.location.href=atob('bWFpbHRvOmhlbGxvQGZyb250aWVyZGlnaXRhbC5uZXQ=')">Contact Us</a></p></li></ul></div></div><div class="col-sm-12 col-md-6 col-lg-2 col-xl-4"><div class="footer-links mb-40"><h6 class=h6-xl>Useful Links</h6><ul class="foo-links text-secondary clearfix"><li><p class=p-md><a href=#>Terms of Use</a></p></li><li><p class=p-md><a href=#>Privacy Policy</a></p></li><li><p class=p-md><a href=#>Cookie Policy</a></p></li><li><p class=p-md><a href=#>Site Map</a></p></li></ul></div></div></div><hr><div class=bottom-footer><div class="row row-cols-1 row-cols-md-2 d-flex align-items-center"><div class=col><div class=footer-copyright><p>&copy; 2023 Frontier Digital Ltd</p></div></div><div class=col><ul class="bottom-footer-list text-secondary text-end"><li class=first-li><p><a href=https://twitter.com/frontierdigita2>Twitter</a></p></li><li class=last-li><p><a href=https://www.linkedin.com/company/85886980/>LinkedIn</a></p></li></ul></div></div></div></div></footer></div><script src=/js/jquery-3.6.0.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/modernizr.custom.js></script>
<script src=/js/jquery.easing.js></script>
<script src=/js/jquery.appear.js></script>
<script src=/js/jquery.scrollto.js></script>
<script src=/js/menu.js></script>
<script src=/js/imagesloaded.pkgd.min.js></script>
<script src=/js/isotope.pkgd.min.js></script>
<script src=/js/owl.carousel.min.js></script>
<script src=/js/jquery.magnific-popup.min.js></script>
<script src=/js/quick-form.js></script>
<script src=/js/request-form.js></script>
<script src=/js/jquery.validate.min.js></script>
<script src=/js/jquery.ajaxchimp.min.js></script>
<script src=/js/wow.js></script>
<script src=/js/custom.js></script>
<script type=text/javascript id=hs-script-loader async defer src=//js.hs-scripts.com/22238495.js></script></body></html>